<script lang="ts">
    import { FormatDate } from "$functions/format_date";
    import Upload from "$icons/Upload/Index.svelte";
    import Search from "$icons/Search/Index.svelte";
    import Cross from "$icons/Cross/Index.svelte";
    import Login from "./Login.svelte";
    import Edit from "$icons/Edit/Index.svelte";
    import prettyBytes from "pretty-bytes";
    import { upload_file_to_doodstream } from "./functions/doodsteam_upload";

    let has_token = false;
    let file_array = new Array<File>();
    let table_file_array = new Array<File>();
    let upload_state: "null" | "selecting" | "uploading" = "null";
    let tokens: { [key in "doodstream"]: string };

    $: {
        if (tokens) {
            has_token = true;
        }
    }
    $: table_file_array = file_array;
    const handle_file_input = (event: Event) => {
        const target = event.target as HTMLInputElement;
        const files = target.files;
        if (!files) {
            return;
        }

        Array.from(files).forEach((item) => {
            file_array = [...file_array, item];
        });

        upload_file_to_doodstream({ api_key: tokens.doodstream, file: file_array[0] });
    };
</script>

{#if !has_token}
    <Login
        on:submit={(event) => {
            tokens = event.detail;
        }}
    />
{:else}
    <div class="flex h-screen w-screen flex-col bg-secondary p-5 md:gap-[3vw] md:px-[5vw] md:py-[3vw]">
        <div class="grid grid-cols-12 gap-7 md:gap-[5vw] md:px-[10vw]">
            <div class="col-span-12 mt-20 flex items-end md:col-span-7 md:pb-[1.5vw]">
                <div class="w-full text-center md:text-left">
                    {#if upload_state === "selecting"}
                        <progress class="progress progress-primary w-full md:h-[0.75vw]" />
                    {:else if upload_state === "null"}
                        <progress
                            class="progress progress-primary w-full md:h-[0.75vw]"
                            value="0"
                        />
                    {:else if upload_state === "uploading"}
                        <progress
                            class="progress progress-primary w-full md:h-[0.75vw]"
                            value="0"
                            max="100"
                        />
                    {/if}
                    <div class="mt-5 flex flex-col gap-3 leading-none md:mt-[1.5vw] md:gap-[0.5vw]">
                        <span class="font-semibold md:text-[1vw]">
                            {prettyBytes(file_array?.reduce((total, current) => total + current.size, 0))}
                        </span>
                        <span class="text-surface-50 md:text-[1vw]">{file_array.length} files</span>
                    </div>
                </div>
            </div>

            <div class="relative col-span-12 flex cursor-pointer flex-col items-center justify-center bg-neutral md:col-span-5 md:h-[12vw] md:gap-[0.25vw] md:rounded-[0.75vw]">
                <input
                    type="file"
                    multiple={true}
                    class="absolute bottom-0 left-0 right-0 top-0 z-10 w-full cursor-pointer opacity-0"
                    on:input|preventDefault={handle_file_input}
                />
                <Upload class="text-white md:w-[2vw]" />
                <span class="font-semibold md:mt-[1vw] md:text-[1.1vw]">Drag and Drop files</span>
                <div class="divider m-0 before:bg-accent/25 after:bg-accent/25 md:px-[10vw] md:text-[0.9vw] md:before:h-[0.15vw] md:after:h-[0.15vw]">Or</div>
                <span class="font-semibold md:text-[1.1vw]">Browse</span>
            </div>
        </div>
        <div class="divider md:m-0 md:before:h-[0.2vw] md:after:h-[0.2vw]"></div>
        <div>
            <div class="flex flex-col justify-between md:flex-row">
                <div class="flex items-center justify-between md:justify-start md:gap-[3vw]">
                    <form class="relative flex items-center">
                        <button
                            class="absolute left-2 p-0 md:left-[1vw]"
                            aria-label="Search"
                        >
                            <Search class="opacity-75 md:w-[1.25vw]" />
                        </button>
                        <input
                            type="text"
                            placeholder="Search"
                            class="placeholder:text-surface-50 h-full w-56 rounded-lg border-none bg-neutral pl-12 text-base leading-none text-white shadow-lg !ring-0 placeholder:font-medium md:w-full md:rounded-[0.5vw] md:py-[0.75vw] md:pl-[3vw] md:text-[1.1vw]"
                        />
                    </form>
                    <div class="relative flex items-center">
                        <button
                            class="absolute left-2 p-0 md:left-[1vw]"
                            aria-label="Search"
                        >
                            <Cross class="opacity-75 md:w-[1.25vw]" />
                        </button>
                        <input
                            type="text"
                            placeholder="Folder Name"
                            class="placeholder:text-surface-50 h-full w-56 rounded-lg border-none bg-neutral pl-12 text-base leading-none text-white shadow-lg !ring-0 placeholder:font-medium md:w-full md:rounded-[0.5vw] md:py-[0.75vw] md:pl-[3vw] md:text-[1.1vw]"
                        />
                    </div>
                </div>

                <div class="mt-5 flex justify-between md:mt-0 md:justify-start md:gap-[3vw]">
                    <button class="text-surface-50 btn flex min-h-full gap-3 !bg-transparent p-0 text-base font-semibold capitalize leading-none md:gap-[0.5vw] md:rounded-[0.25vw] md:text-[1vw]">
                        <Edit class="w-4 md:w-[1vw]" />

                        <span>Rename</span>
                    </button>
                    <button class="text-surface-50 btn flex min-h-full gap-3 !bg-transparent p-0 text-base font-semibold capitalize leading-none md:gap-[0.5vw] md:rounded-[0.25vw] md:text-[1vw]">
                        <Edit class="w-4 md:w-[1vw]"></Edit>
                        <span>Edit Details</span>
                    </button>
                    <button class="text-surface-50 btn flex min-h-full gap-3 !bg-transparent p-0 text-base font-semibold capitalize leading-none md:gap-[0.5vw] md:rounded-[0.25vw] md:text-[1vw]">
                        <coreproject-icon-delete class="w-4 md:w-[1vw]"></coreproject-icon-delete>
                        <span>Delete</span>
                    </button>
                </div>
            </div>

            <div
                hidden
                class="mt-10 block md:mt-[3vw]"
            >
                <table class="text-surface-50 w-full border-separate border-spacing-y-2 leading-none md:border-spacing-y-[0.25vw]">
                    <thead>
                        <tr class="text-left md:text-[1vw]">
                            <th>
                                <input
                                    type="checkbox"
                                    class="cursor-pointer rounded border-2 bg-transparent focus:ring-0 focus:ring-offset-0 md:h-[1.25vw] md:w-[1.25vw] md:border-[0.2vw]"
                                />
                            </th>
                            <th>
                                <div class="flex items-center md:gap-[0.5vw]">
                                    <span class="capitalize">name</span>
                                    <button class="btn min-h-full !bg-transparent p-0">
                                        <coreproject-icon-chevron class="w-[1vw]"></coreproject-icon-chevron>
                                    </button>
                                    <button class="btn min-h-full !bg-transparent p-0">
                                        <coreproject-icon-chevron class="rotate-180 opacity-50 md:w-[1vw]"></coreproject-icon-chevron>
                                    </button>
                                </div>
                            </th>
                            <th>
                                <div class="flex items-center md:gap-[0.5vw]">
                                    <span class="capitalize">date modified</span>
                                    <button class="btn min-h-full !bg-transparent p-0">
                                        <coreproject-icon-chevron class="w-[1vw]"></coreproject-icon-chevron>
                                    </button>
                                    <button class="btn min-h-full !bg-transparent p-0">
                                        <coreproject-icon-chevron class="rotate-180 opacity-50 md:w-[1vw]"></coreproject-icon-chevron>
                                    </button>
                                </div>
                            </th>
                            <th>
                                <div class="flex items-center md:gap-[0.5vw]">
                                    <span class="capitalize">size</span>
                                    <button class="btn min-h-full !bg-transparent p-0">
                                        <coreproject-icon-chevron class="w-[1vw]"></coreproject-icon-chevron>
                                    </button>
                                    <button class="btn min-h-full !bg-transparent p-0">
                                        <coreproject-icon-chevron class="rotate-180 opacity-50 md:w-[1vw]"></coreproject-icon-chevron>
                                    </button>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {#each table_file_array as item}
                            <tr>
                                <td></td>
                                <td>{item.name}</td>
                                <td>{new FormatDate(new Date(item.lastModified).toISOString()).format_to_human_readable_form}</td>
                                <td>{prettyBytes(item.size)}</td>
                            </tr>
                        {/each}
                    </tbody>
                </table>
                {#if file_array.length === 0}
                    <div class="flex w-full flex-col items-center justify-center md:flex-row md:gap-[2vw]">
                        <coreproject-icon-empty class="w-32 stroke-accent stroke-[0.15vw] md:w-[10vw] md:stroke-accent/50"></coreproject-icon-empty>
                        <div class="flex flex-col items-center gap-2 md:items-start md:gap-[0.75vw]">
                            <span class="text-base font-semibold leading-none text-accent md:text-[1.4vw]">Empty!</span>
                            <span class="text-sm leading-none text-accent/50 md:text-[1.1vw]">Upload something to make kokoro-chan happy</span>
                        </div>
                    </div>
                {/if}
            </div>
        </div>
    </div>
{/if}
